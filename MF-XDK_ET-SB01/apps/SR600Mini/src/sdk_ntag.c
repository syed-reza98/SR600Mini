#include "sdk_ntag.h"
#include "tracedef.h"
#include <stdio.h>
#include "pub/taskdef.h"
#include "libapi_xpos/inc/libapi_system.h"
#include "pub/qrencode/QrEncode.h"
#include "page_main.h"
#include "libapi_xpos/inc/mfsdk_sys.h"
#include "./pages/page_qr.h"
#include "./pages/pages.h"
#include "./page_pub.h"


static lv_obj_t* page_ntag = NULL;
static lv_obj_t* lab_timer = NULL;
static lv_obj_t* sub_win = NULL;
static lv_obj_t* ntagqr = NULL;
static lv_task_t *ntagTimer_task = NULL;
static char ntag_url[256] = {0};
static int ntag_ret = 0;
static int m_timeover = 0;
#define CHECK_TIMER		(500)

static unsigned char CARD_UID_INFO[25] = 
{
	0x44,0x00,					//SENS_RES(2 bytes)
	0x01,0x02,0x03,				//NFCID1(  bytes)
	0x00,						//SEL_RES(1 byte)
	0x01,0xFE,					//polling response 
	0xF0,0xF1,0xF2,0xF3,0xF4,0xF5,	//NFCID2(6 bytes)
	0x80,0x81,0x82,0x83,0x84,0x85,0x86,0x87, //pad (8 bytes)
	0xAA,0xBB, //system code (2 bytes)
	0xFE //NFCID3 (1 byte)
};


#define Block_Capacity 231

// NTAG216
unsigned char Ntag_Block[Block_Capacity][4]= 
{
	{0x04,0xDF,0x73,0x20}, 
	{0x2A,0x5B,0x49,0x80}, 
	{0xB8,0x48,0x00,0x00},
	{0xE1,0x10,0x6D,0x00},
	{0x03,0x0E,0xD1,0x01},
	{0x0A,0x55,0x01,0x62},
	{0x61,0x69,0x64,0x75},
	{0x2E,0x63,0x6F,0x6D},
	{0xFE,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0xBD},
	{0x04,0x00,0x00,0xFF},
	{0x00,0x05,0x00,0x00},
	{0xFF,0xFF,0xFF,0xFF},
	{0x00,0x00,0x00,0x00}
};

static void set_ntag_block(unsigned char *buff, int length)
{
	int i = 0;

	APP_TRACE_BUFF_TIP(buff, length, "NDEF MESSAGE");

	if (length > 0)
	{
		Ntag_Block[4][1] = length;
		Ntag_Block[4][2] = buff[0];
		Ntag_Block[4][3] = buff[1];
		for (i=0; i<length-2; i++)
		{
			Ntag_Block[i/4+5][i%4] = buff[i+2];
		}
		Ntag_Block[i/4+5][i%4] = 0xFE;
	}
	APP_TRACE_BUFF_TIP(Ntag_Block, 60, "NTAG BLOCK");
}

static char get_url_type(char * url, pload_data *pload)
{
	if (strstr(url, "http://") != NULL)
	{
		if (strstr(url, "www.") != NULL)
		{
			pload->len = strlen(url) - 11;
			pload->pyload = url + 11;
			return URI_ID_0x01;
		}
		else
		{
			pload->len = strlen(url) - 7;
			pload->pyload = url + 7;
			return URI_ID_0x03;
		}
	}
	else if (strstr(url, "https://") != NULL)
	{
		if (strstr(url, "www.") != NULL)
		{
			pload->len = strlen(url) - 12;
			pload->pyload = url + 12;
			return URI_ID_0x02;
		}
		else
		{
			pload->len = strlen(url) - 8;
			pload->pyload = url + 8;
			return URI_ID_0x04;
		}
	}
	return URI_ID_0x00;
}

static void set_ntag_url(char *url)
{
	char ndefMessage[256] = {0};
	pload_data payload = {0};

	ndefMessage[0] = 0xD1;
	ndefMessage[1] = 0x01;
	ndefMessage[3] = 0x55;
	ndefMessage[4] = get_url_type(url, &payload);
	ndefMessage[2] = payload.len + 1;
	APP_TRACE("payload.len = %d", payload.len);
	memcpy(&ndefMessage[5], payload.pyload, payload.len);

	set_ntag_block((u8*)ndefMessage, strlen(ndefMessage));
}

static int NfcTagEmulateInitSetUrl(u8* url)
{
	int ret = -1;
	
	if (NULL == url) return ret;

	ret = MfSdkSysRfidEmulateInit();
	set_ntag_url((char*)url);
	ret = MfSdkSysRfidEmulateConfig(CARD_UID_INFO, sizeof(CARD_UID_INFO), Ntag_Block, Block_Capacity);
	APP_TRACE("[%s][%d]MfSdkSysRfidEmulateConfig = %d", __FUNCTION__, __LINE__, ret);
	return ret;
}

static void ntag_task(void* p)
{
	int ret = -1;
	unsigned int count = 0;
	unsigned int tick1 = MfSdkSysTimerOpen(1500);

	NfcTagEmulateInitSetUrl(ntag_url);
	while (1)
	{
		MfSdkSysRfidEmulateProcess();
		if (MfSdkSysTimerCheck(tick1)==0)
		{
			APP_TRACE("[%s][%d][seconds:%d]", __FUNCTION__, __LINE__, count++);
			tick1 = MfSdkSysTimerOpen(1500);
			MfSdkSysSleep(500);
		}
		if (ntag_ret != 999) {
			break;
		}
	}
	ret = MfSdkSysRfidEmulateDeinit();
	APP_TRACE("[%s][%d][end] %d", __FUNCTION__, __LINE__, ret);
}

static void _ntag_close_page(int ret)
{
	if (ntagTimer_task != NULL)
	{
		lv_task_del(ntagTimer_task);
		ntagTimer_task = NULL;
	}
	if (page_ntag != NULL)
	{
		if (lab_timer != NULL)
		{
			lv_obj_del(lab_timer);
			lab_timer = NULL;
		}
		lv_obj_del(page_ntag);
		page_ntag = NULL;
	}
	if (sub_win != NULL)
	{
		if (ntagqr)
		{
			lv_qrcode_delete(ntagqr);
			ntagqr = NULL;
		}
		lv_obj_del(sub_win);
		sub_win = NULL;
	}
	ntag_ret = 0;
	memset(ntag_url, 0, sizeof(ntag_url));
	AppPowerUnlockApp((char*)"ntag");
}

static void _ntag_event_cb(lv_obj_t* obj, lv_event_t e)
{
	uint32_t key;

	if (e == LV_EVENT_KEY) 
	{
		key = page_get_key();

		APP_TRACE("[%s][%d][key_cb:%d]", __FUNCTION__, __LINE__, key);
		if (key == MF_LV_KEY_CANCEL_SHORT_PRESS || key == MF_LV_KEY_OK_SHORT_PRESS) 
		{
			_ntag_close_page(0);
		}
	}
}

static void ntag_task_func(lv_task_t *pTask)
{
	char time_set[32] = {0};
	if (m_timeover > 0) 
	{
		m_timeover -= CHECK_TIMER;
		//snprintf(time_set, sizeof(time_set), "(%02ds)", m_timeover / 1000);
		//page_show_text_font(lab_timer, time_set, LCD_DISP_FRONT);
		if (m_timeover <= 0) 
		{
			_ntag_close_page(PAGE_RET_TIMEOVR);
		}
	}
}

lv_obj_t* NTAG_Page(char *url)
{
	char time_set[32] = {0};
	if (NULL == url) return 0;

	memset(ntag_url, 0, sizeof(ntag_url));
	strcpy(ntag_url, url);
	m_timeover = 60*1000;

	AppPowerLockApp((char*)"ntag");
	lv_obj_t* subparent = get_subpage();
	page_ntag = lv_obj_create(subparent, NULL);
	lv_obj_set_style_local_radius(page_ntag, LV_OBJ_PART_MAIN, LV_STATE_DEFAULT, 0);
	lv_obj_set_size(page_ntag, lv_obj_get_width(subparent), lv_obj_get_height(subparent));
	page_create_title(page_ntag, "NTAG");
	page_ShowTextOut(page_ntag, "Please TAP", LV_ALIGN_CENTER, 0, 0, LV_COLOR_BLACK, LV_FONT_MF12);

	sub_win = page_create_win(get_mainpage(), _ntag_event_cb);

	if (LCD_IS_128_32)
	{
		page_ShowTextOut(sub_win, "Please TAP", LV_ALIGN_CENTER, 0, 0, LV_COLOR_BLACK, LV_FONT_MF12);
	}
	else
	{
		page_select_disp(LCD_DISP_FRONT);
		page_create_title(sub_win, "NTAG");
		page_select_disp(LCD_DISP_BEHIND);
		//page_ShowTextOut(sub_win, ntag_url, LV_ALIGN_CENTER, 0, 0, LV_COLOR_BLACK, LV_FONT_24);
		//snprintf(time_set, sizeof(time_set), "(%02ds)", m_timeover / 1000);
		//lab_timer = page_ShowTextOut(page_ntag, time_set, LV_ALIGN_IN_BOTTOM_MID, 0, 0, LV_COLOR_BLACK, LV_FONT_24);
		
		/*Create a QR code*/
		ntagqr = lv_qrcode_create(sub_win, lv_obj_get_width(sub_win)-2*30, LV_COLOR_BLACK, LV_COLOR_WHITE);
		lv_obj_align(ntagqr, sub_win, LV_ALIGN_CENTER, 0, 40);

		/*Set data*/
		lv_qrcode_update(ntagqr, ntag_url, strlen(ntag_url));
	}

	if(m_timeover > 0)
	{
		ntagTimer_task = lv_task_create(ntag_task_func, CHECK_TIMER, LV_TASK_PRIO_MID, 0);
	}
	
	ntag_ret = 999;
	MfSdkSysTaskAppSet(ntag_task);

	return page_ntag;
}

lv_obj_t* NTAG_QrPage(char *url)
{	
	if (NULL == url) return 0;
	
	memset(ntag_url, 0, sizeof(ntag_url));
	strcpy(ntag_url, url);

	AppPowerLockApp((char*)"ntag");
	SetPowerLock(QRPAGE_LOCK_OFF);
    show_page_qrcode(get_mainpage(), NULL, 0, ntag_url, 60*1000);

	ntag_ret = 999;
	MfSdkSysTaskAppSet(ntag_task);

	return page_ntag;
}

